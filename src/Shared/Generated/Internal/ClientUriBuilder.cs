// <auto-generated/>

#nullable disable

using System;
using System.Collections.Generic;
using System.Text;

namespace OpenAI
{
    // Lightweight URI builder used by generated REST clients.
    internal partial class ClientUriBuilder
    {
        private readonly StringBuilder _pathBuilder = new StringBuilder();
        private readonly List<string> _queryParts = new List<string>();
        private Uri _baseUri = null!;

        public void Reset(Uri baseUri)
        {
            _baseUri = baseUri ?? throw new ArgumentNullException(nameof(baseUri));
            _pathBuilder.Clear();
            _queryParts.Clear();
        }

        public void AppendPath(string path, bool escape)
        {
            if (string.IsNullOrEmpty(path))
            {
                return;
            }

            string segment = escape ? Uri.EscapeDataString(path) : path;

            // Ensure a single separator between existing path and the new segment.
            bool endsWithSlash = _pathBuilder.Length > 0 && _pathBuilder[_pathBuilder.Length - 1] == '/';
            bool startsWithSlash = segment.Length > 0 && segment[0] == '/';

            if (!endsWithSlash && !startsWithSlash)
            {
                _pathBuilder.Append('/');
            }
            else if (endsWithSlash && startsWithSlash)
            {
                segment = segment.TrimStart('/');
            }

            _pathBuilder.Append(segment);
        }

        public void AppendQuery(string name, object value, bool escape)
        {
            if (name == null)
            {
                throw new ArgumentNullException(nameof(name));
            }

            if (value == null)
            {
                return;
            }

            string encodedName = escape ? Uri.EscapeDataString(name) : name;
            string stringValue = value.ToString();
            if (stringValue == null)
            {
                return;
            }

            string encodedValue = escape ? Uri.EscapeDataString(stringValue) : stringValue;
            _queryParts.Add($"{encodedName}={encodedValue}");
        }

        public void AppendQueryDelimited<T>(string name, IEnumerable<T> values, string delimiter, bool escape)
        {
            if (name == null)
            {
                throw new ArgumentNullException(nameof(name));
            }

            if (values == null)
            {
                return;
            }

            string combined = string.Join(delimiter, EncodeValues(values, escape));
            if (combined.Length == 0)
            {
                return;
            }

            string encodedName = escape ? Uri.EscapeDataString(name) : name;
            _queryParts.Add($"{encodedName}={combined}");
        }

        public Uri ToUri()
        {
            UriBuilder builder = new UriBuilder(_baseUri);
            builder.Path = CombinePaths(_baseUri.AbsolutePath, _pathBuilder.ToString());
            builder.Query = _queryParts.Count > 0 ? string.Join("&", _queryParts) : string.Empty;
            return builder.Uri;
        }

        private static string CombinePaths(string basePath, string relativePath)
        {
            if (string.IsNullOrEmpty(relativePath))
            {
                return basePath;
            }

            bool baseEndsWithSlash = basePath.EndsWith("/", StringComparison.Ordinal);
            bool relStartsWithSlash = relativePath.StartsWith("/", StringComparison.Ordinal);

            if (baseEndsWithSlash && relStartsWithSlash)
            {
                return basePath + relativePath.TrimStart('/');
            }

            if (!baseEndsWithSlash && !relStartsWithSlash)
            {
                return basePath + "/" + relativePath;
            }

            return basePath + relativePath;
        }

        private static IEnumerable<string> EncodeValues<T>(IEnumerable<T> values, bool escape)
        {
            foreach (T value in values)
            {
                if (value == null)
                {
                    continue;
                }

                string stringValue = value.ToString();
                if (stringValue == null)
                {
                    continue;
                }

                yield return escape ? Uri.EscapeDataString(stringValue) : stringValue;
            }
        }
    }
}
